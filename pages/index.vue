<template>
    <section :class="classes">
        <div
            class="panel-top"
            @click="onClick"
        >
            <wp-image
                class="image intro"
                :image="introImage"
                mode="cover"
            />
            <gallery-home
                :items="galleryImages"
                :intro-is-complete="!$store.state.introIsActive"
            />
        </div>

        <div
            v-intersection-observer="{
                rootMargin: '100000% 0px -50% 0px'
            }"
            class="waypoint"
            @has-intersected="onIntersected"
        />

        <div class="panel-bottom">
            <grid-work :items="gridItems" />
        </div>
    </section>
</template>

<script>
// Queries
import HOME from "~/gql/queries/Home"

export default {
    async asyncData({ $graphql, route }) {
        const data = await $graphql.default.request(HOME)
        return {
            page: data?.nodeByUri || {}
        }
    },
    computed: {
        classes() {
            return [
                "page-home",
                { "intro-is-complete": !this.$store.state.introIsActive }
            ]
        },
        introImage() {
            return this.page?.featuredImage?.node || {}
        },
        // TODO: ok to use gallery instread of child pages?
        galleryImages() {
            return this.page?.homeMeta?.imageGallery || []
        },
        gridItems() {
            let items = this.page?.children?.nodes || []

            return items.map((obj) => {
                return {
                    ...obj,
                    image: obj?.featuredImage?.node || {},
                    imageSecondary:
                        obj?.secondaryFeaturedImage?.secondaryFeaturedImage ||
                        {},
                    tags: obj?.tags?.nodes || [],
                    type: obj?.workMeta?.type || "",
                    link: obj?.workMeta?.link || "",
                    publication: obj?.workMeta?.publication || "",
                    talent: obj?.workMeta?.talentName || "",
                    category: obj?.workMeta?.workCategory || ""
                }
            })
        }
    },
    mounted() {
        if (!this.$store.state.referrer) {
            this.playIntro()
        } else {
            this.endIntro()
        }
    },
    methods: {
        playIntro() {
            this.$store.commit("SET_INTRO", true)

            // start at top
            window.scrollTo({
                top: 0,
                behavior: "smooth"
            })

            setTimeout(() => {
                this.endIntro()
            }, 2000)
        },
        endIntro() {
            this.$store.commit("SET_INTRO", false)
        },
        onIntersected(event) {
            if (event.detail.isIntersecting) {
                this.$store.commit("SET_THEME", "gray")
            } else {
                this.$store.commit("SET_THEME", "white")
            }
        },
        onClick() {
            document.querySelector(".panel-bottom").scrollIntoView({
                behavior: "smooth"
            })
        }
    }
}
</script>

<style lang="scss" scoped>
.page-home {
    min-height: var(--unit-100vh);
    height: 100%;
    margin: 0 auto;
    overflow: hidden;
    .panel-top {
        position: relative;
        background-color: var(--color-black);
        cursor: pointer;
    }

    .image {
        height: var(--unit-100vh);
        width: auto;
    }

    .panel-bottom {
        height: 100%;
    }

    // Hover states
    @media #{$has-hover} {
        // Hover styles would go here
    }

    // Breakpoints
    @media #{$lt-phone} {
        // Phone styles would go here
    }
}
</style>
